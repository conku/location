"use strict";function qorInitMapAssets(o){$(o).each(function(){var o=$(this),t=o.data(),i=t.locationMapsource,e=t[i+"Apikey"],a="qor_map_"+i,n=void 0;if("baidu"===i){if($("#"+a).length)return void new QorLocation($(this)).initBaiduMap();n="//api.map.baidu.com/api?v=2.0&ak="+e+"&callback=qorInitBaiduMap"}else if("google"===i){if($("#"+a).length)return void new QorLocation($(this)).initGoogleMap();n="//maps.googleapis.com/maps/api/js?key="+e+"&callback=qorInitGoogleMap"}else console.log("QOR only support baidu or google Map, please make sure your Map config is correct!");qorLoadMapScript(n,a)})}function qorInitBaiduMap(){$('[data-toggle="qor.location"]').each(function(){new QorLocation($(this)).initBaiduMap()})}function qorInitGoogleMap(){$('[data-toggle="qor.location"]').each(function(){new QorLocation($(this)).initGoogleMap()})}function qorLoadMapScript(o,t){var i=document.createElement("script");i.src=o,i.id=t,document.body.appendChild(i)}function QorLocation(o,t){this.$element=$(o),this.options=$.extend({},QorLocation.DEFAULTS,$.isPlainObject(t)&&t),this.roles={},this.init()}QorLocation.prototype={constructor:QorLocation,init:function(){var o=this.$element.find("[data-location-role]"),t=this.roles,i=void 0;this.MAP_ID=this.$element.find(".qor__location-map")[0],this.locationMapsource=this.$element.data("location-mapsource"),o.each(function(){i=$(this).data("location-role"),t["$"+i]=$(this)}),this.bind()},bind:function(){this.roles.$reverseGeocode.on("click",this.getAddress.bind(this)),this.roles.$geocode.on("click",this.getPosition.bind(this))},initGoogleMap:function(){var o={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},t=this.roles,i=Number(t.$latitude.val()),e=Number(t.$longitude.val()),a=this;0===i&&0===e?navigator.geolocation.getCurrentPosition(function(o){a.setupGoogleMap({lat:o.coords.latitude,lng:o.coords.longitude})},function(o){console.warn("ERROR("+o.code+"): "+o.message)},o):this.setupGoogleMap({lat:i,lng:e})},setupGoogleMap:function(o){this.map=new google.maps.Map(this.MAP_ID,{center:o,zoom:16}),this.marker=new google.maps.Marker({position:o,draggable:!0,map:this.map}),this.mapGeo=new google.maps.Geocoder,google.maps.event.bind(this.marker,"dragend",this,this.moveGoogleMapMarker)},moveGoogleMapMarker:function(){},initBaiduMap:function(){var o=this.roles,t=Number(o.$latitude.val()),i=Number(o.$longitude.val()),e=new BMap.Point(i,t),a=this;if(0===t&&0===i){(new BMap.Geolocation).getCurrentPosition(function(o){this.getStatus()==BMAP_STATUS_SUCCESS?a.setupBaiduMap(o.point):console.log("failed"+this.getStatus())},{enableHighAccuracy:!0})}else this.setupBaiduMap(e)},setupBaiduMap:function(o){var t=new BMap.Map(this.MAP_ID),i=new BMap.Marker(o);t.centerAndZoom(o,18),t.enableScrollWheelZoom(),t.addOverlay(i),t.panTo(o),i.enableDragging().addEventListener("dragend",this.moveBaiduMapMarker.bind(this)),this.marker=i,this.map=t,this.mapGeo=new BMap.Geocoder,this.moveBaiduMapMarker(i.getPosition())},moveBaiduMapMarker:function(o){var t=this.$element.find(".qor__location-address");this.mapGeo.getLocation(new BMap.Point(o.lng||o.point.lng,o.lat||o.point.lat),function(o){o&&t.html(o.address)})},getPosition:function(){var o=this.map,t=this.roles,i=this.marker,e=t.$city.val(),a=t.$address.val(),n=this.mapGeo;if(""==e||""==a)return void window.QOR.qorConfirm("Please ensure that the city and address have been filled in correctly!");n.getPoint(a,function(e){e&&(t.$latitude.val(e.lat),t.$longitude.val(e.lng),o.centerAndZoom(e,18),i.setPosition(e))},e)},getAddress:function(){var o=this.marker.getPosition();this.roles.$latitude.val(o.lat),this.roles.$longitude.val(o.lng),this.getAddressFromPosition(o)},getAddressFromPosition:function(o){var t=this.mapGeo,i=this.roles;"google"===this.locationMapsource?t.geocode({location:o},function(o,t){}):t.getLocation(new BMap.Point(o.lng,o.lat),function(o){o&&(i.$address.val(o.address),i.$city.val(o.addressComponents.city),i.$region.val(o.addressComponents.district))})}},$(function(){var o='[data-toggle="qor.location"]';qorInitMapAssets(o),$(document).on("enable.qor.location",function(){qorInitMapAssets(o)})});